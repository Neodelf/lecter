= javascript_include_tag 'highlight.pack.js', '//code.jquery.com/jquery-1.12.4.js', '//code.jquery.com/ui/1.12.1/jquery-ui.js'
= stylesheet_link_tag 'railscasts'

= content_for :title, t('.title')

.sidebar
  .sidebar-wrapper
    ul
      - @lines.each_with_index do |item, item_index|
        li = link_to item.keys.first.split('/').last, "#anchor#{item_index}"
.right
  h4
    = t('.response_status', status: @response_status)
  - @lines.each_with_index do |item, item_index|
    .filename id="anchor#{item_index}"
      - file = item.keys.first
      .arrow-right
      .filename-title
        = file.remove(Rails.root.to_s)
      - lines = item.values.split(' ').flatten.map(&:to_i)
      - previous_row_is_empty = false
    .listing
      - file_context = File.open(Rails.root.join(file), 'r').read.split("\n")
      - html_rows = []
      - file_context.each_with_index do |row, index_row|
        - include = lines.include?(index_row + 1)
        - if include || lines.reduce(false) { |memo, line| memo || index_row.in?(line - 5..line + 4) }
          - previous_row_is_empty = false
          - html_row = "#{index_row + 1} #{'-> ' + lines.each_with_index.select { |_, index| lines[index] == index_row + 1 }.map { |_, index| index + 1 }.join(', ') if include} #{row}\n"
          - html_rows << content_tag(:code, html_row, style: "#{include ? 'background-color: #4a4a4a;' : nil}")
        - elsif !previous_row_is_empty
          - previous_row_is_empty = true
          - html_rows << "...\n"
      pre
        code
          - html_rows.each do |html_row|
            = html_row

css:
  .arrow-right {
    width: 0;
    height: 0;
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    border-left: 5px solid black;
    float: left;
    margin: 7px;
  }

  .down {
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid black;
    margin: 10px 7px 0 5px;
  }

  .ui-accordion .ui-accordion-header {
    font-size: 78%;
  }

  .sidebar {
    float: left;
  }

  .sidebar > .sidebar-wrapper {
    width: 235px;
    position: fixed;
    margin: 49px 33px 0 0;
    overflow-y: scroll;
    top: 82px;
    bottom: 40px;
  }

  .sidebar-wrapper > ul {
    list-style-type: none;
    height: calc(100% - 40px);
  }

  .sidebar-wrapper > ul > li {
    margin-bottom: 3px;
  }

  .sidebar-wrapper > ul > li > a {
    text-decoration: none;
    color: inherit;
    display: block;
    font-size: 13px;
    text-inline: 1.5;
  }

  .sidebar-wrapper > ul > li > a:hover {
    color: #7d7d7d;
  }

  .right {
    float: left;
    padding-left: 10px;
    width: 70%;
    margin-left: 297px;
  }

  .listing {
    display: none;
    padding: 1em 2.2em;
    overflow: auto;
    border-bottom-right-radius: 4px;
    border: 0.5px solid;
    border-top-width: 0;
    border-bottom-left-radius: 4px;
    background: #efefef;
  }

  .filename {
    cursor: pointer;
    position: relative;
    margin: 2px 0 0 0;
    padding: .5em .5em .5em .7em;
    border: solid 0.1px;
    background: #efefef;
  }

javascript:
  $(document).ready(function(){
    hljs.initHighlighting();

    $('.filename').on('click', function(){
      $(this).find('.arrow-right').toggleClass('down')
      $(this).next().slideToggle();
    });

    $('.sidebar-wrapper > ul > li > a').on('click', function(){
      var anchor = $(this).first().attr('href').split('#').pop();
      $('.filename#'+anchor).click();
    });
  })
